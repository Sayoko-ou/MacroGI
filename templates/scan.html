{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/scan.css') }}">
<div class="scanner-wrapper">
    <div class="scan-left">
        <div class="card upload-card">
            <div id="image-preview-container" class="preview-box hidden">
                <img id="image-preview" src="" alt="Preview">
                <button id="clear-image-btn">√ó</button>
            </div>

            <div id="initial-actions" class="upload-actions">
                <button class="upload-btn" onclick="document.getElementById('file-upload').click()">üìÅ Upload</button>
                <button class="upload-btn" onclick="startCamera()">üì∑ Camera</button>
            </div>

            <div id="live-camera-container" class="hidden" style="text-align: center; margin-top: 15px;">
                <video id="live-video" autoplay playsinline style="width: 100%; max-width: 400px; border-radius: 8px; background-color: #000;"></video>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button id="snap-photo-btn" class="main-btn">üì∏ Snap Photo</button>
                    <button id="cancel-camera-btn" style="padding: 10px 20px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer;">Cancel</button>
                </div>
            </div>
            
            <canvas id="camera-canvas" hidden></canvas>

            <input type="file" id="file-upload" accept="image/*" hidden>
            <input type="file" id="camera-upload" accept="image/*" capture="environment" hidden>
            
            <button id="scan-now-btn" class="main-btn hidden">Run Scanner</button>
            
            <div id="loading-spinner" class="hidden" style="margin-top:15px; text-align:center;">
                <div class="spinner"></div> Scanning...
            </div>
        </div>

        <div class="card meta-card">
            <h3>Meal Details</h3>
            <div class="input-group">
                <label>Food Name</label>
                <input type="text" id="food-name" class="std-input" placeholder="e.g. Banana">
            </div>
            <div style="display: flex; gap: 20px;">
                <div class="input-group" style="flex: 1;">
                    <label>Meal Type</label>
                    <select id="meal-type" class="std-input">
                        <option value="Breakfast">Breakfast</option>
                        <option value="Lunch">Lunch</option>
                        <option value="Dinner">Dinner</option>
                        <option value="Snack">Snack</option>
                    </select>
                </div>
                <div class="input-group" style="flex: 1;">
                    <label>Insulin (Units)</label>
                    <input type="number" id="insulin-input" step="0.5" placeholder="0.0" class="std-input">
                    <div id="insulin-advisor-hint" class="hidden" style="margin-top: 6px; padding: 8px 10px; background: #f0fdf4; border-left: 3px solid #28a745; border-radius: 4px; font-size: 0.8em; line-height: 1.4;">
                        <div style="font-weight: 700; color: #166534; margin-bottom: 2px;">Suggested: <span id="advisor-total">--</span> units</div>
                        <div style="color: #555;" id="advisor-breakdown"></div>
                        <div style="color: #999; font-size: 0.85em; margin-top: 3px;">Estimate only ‚Äî consult your healthcare provider.</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 20px; margin-top: 8px;">
                <div class="input-group" style="flex: 1;">
                    <label>ISF <span style="font-weight: 400; color: #aaa;">(optional)</span></label>
                    <input type="number" id="isf-input" step="0.1" min="1" class="std-input" placeholder="Auto">
                    <small style="color: #aaa; font-size: 0.75em;" id="isf-scan-hint">mg/dL per unit</small>
                </div>
                <div class="input-group" style="flex: 1;">
                    <label>ICR <span style="font-weight: 400; color: #aaa;">(optional)</span></label>
                    <input type="number" id="icr-input" step="0.1" min="1" class="std-input" placeholder="Auto">
                    <small style="color: #aaa; font-size: 0.75em;" id="icr-scan-hint">g carbs per unit</small>
                </div>
            </div>
        </div>
    </div>

    <div class="scan-right">
        <div class="card table-card">
            <div class="card-header">
                <h3>Nutrition Facts</h3>
                <span class="badge">Editable</span>
            </div>
            
            <div id="retake-prompt" class="warning-box hidden">
                ‚ö†Ô∏è <strong>No text detected.</strong> Try retaking with better light or manual entry.
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Nutrient</th>
                        <th style="width: 25%;">Value</th>
                        <th style="width: 25%;">Unit</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody id="nutrient-table-body">
                    <tr class="empty-state-row"><td colspan="4" style="text-align:center; padding: 40px; color: #aaa;">Upload an image to see data</td></tr>
                </tbody>
            </table>

            <button id="add-row-btn" class="subtle-btn">+ Add Nutrient</button>
        </div>

        <div class="card ai-card">
            <div class="ai-header">
                <h3>AI Analysis</h3>
                <button id="predict-gi-btn" class="ai-btn">Predict GI & GL</button>
            </div>
            <div id="gi-result-area" class="ai-content hidden">
                <div style="display: flex; gap: 15px;">
                    <div class="gi-box" style="flex: 1;">
                        <span class="gi-label">Predicted GI</span>
                        <span id="gi" class="gi-value">--</span>
                    </div>
                    <div class="gi-box" style="flex: 1; border-left: 1px solid #eee;">
                        <span class="gi-label">Predicted GL</span>
                        <span id="gl" class="gi-value" style="color: #666;">--</span>
                    </div>
                </div>
                <p class="ai-message"></p>
            </div>
        </div>

        <button id="save-entry-btn" class="save-btn" disabled>Complete all fields to save</button>
        <p id="save-helper-text" class="error-msg">Complete all fields to save</p>
    </div>
</div>
<script src="{{ url_for('static', filename='js/scan.js') }}"></script>
{% endblock %}